<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Order Management</title>

    <link rel="stylesheet" href="views/layouts/adminDash.css">
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 8px 12px;
            border: 1px solid #ddd;
        }

        th {
            background-color: #f2f2f2;
        }
    </style>
</head>

<body>
    <h1>Order Management</h1>
    <table>
        <thead>
            <tr>
                <th>Order ID</th>
                <th>Customer Name</th>
                <th>Items</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="orders-list">
            <!-- The orders will be populated here using JavaScript -->
        </tbody>
    </table>

    <script>
        async function fetchAllOrders() {
            try {
                const response = await fetch('/getAllOrders');
                const orders = await response.json();

                const ordersList = document.getElementById('orders-list');
                ordersList.innerHTML = ''; // Clear previous orders

                orders.forEach(order => {
                    const row = ordersList.insertRow();
                    row.insertCell(0).textContent = order._id;
                    row.insertCell(1).textContent = order.customerName;
                    row.insertCell(2).textContent = order.items.join(', '); // Assuming items is an array
                    row.insertCell(3).textContent = order.status;

                    const actionsCell = row.insertCell(4);
                    if (order.status !== 'Processed') {
                        const processButton = document.createElement('button');
                        processButton.textContent = 'Process';
                        processButton.onclick = () => processOrder(order._id);
                        actionsCell.appendChild(processButton);
                    }

                    const statusSelect = document.createElement('select');
                    ['Pending', 'Shipped', 'Processed'].forEach(status => {
                        const option = document.createElement('option');
                        option.value = status;
                        option.textContent = status;
                        if (order.status === status) {
                            option.selected = true;
                        }
                        statusSelect.appendChild(option);
                    });
                    actionsCell.appendChild(statusSelect);

                    const updateButton = document.createElement('button');
                    updateButton.textContent = 'Update Status';
                    updateButton.onclick = () => updateOrderStatus(order._id, statusSelect.value);
                    actionsCell.appendChild(updateButton);
                });
            } catch (error) {
                console.error('Error fetching orders:', error);
            }
        }

        async function processOrder(orderId) {
            try {
                const response = await fetch(`/processOrder/${orderId}`, {
                    method: 'PUT',
                });
                if (response.ok) {
                    fetchAllOrders(); // Refresh orders after processing
                } else {
                    console.error('Error processing order:', await response.text());
                }
            } catch (error) {
                console.error('Error processing order:', error);
            }
        }

        async function updateOrderStatus(orderId, status) {
            try {
                const response = await fetch(`/updateOrderStatus/${orderId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ status }),
                });
                if (response.ok) {
                    fetchAllOrders(); // Refresh orders after updating status
                } else {
                    console.error('Error updating order status:', await response.text());
                }
            } catch (error) {
                console.error('Error updating order status:', error);
            }
        }

        // On page load, fetch all orders
        window.onload = fetchAllOrders;
    </script>
</body>

</html>
